<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/Frontend/auth.js"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #e6e6e6;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .content {
            flex: 1;
            padding: 30px;
            background-color: #fff;
            margin: 55px 20px 20px 20px;
            height: 82.9vh;
            overflow-y: auto;
        }

        .profile-container{
            background-color: #fafafa;
            border: 0.5px solid black;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* Hidden by default */
        }

        

        .profile-container  h3 {
            margin-top: 0;
        }

        .back {
            font-size: 18px;
            color: #2c3e50;
            text-decoration: none;
            cursor: pointer;
            background-color: #E9EFF1;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            position: absolute;
            top: 7px;
            left: 10px;
            transition: background-color 0.3s ease;
        }

        .back:hover {
            background-color: #BDC3C7;
        }

        .back i {
            margin-right: 8px;
        }

        .sidebar a {
            text-decoration: none;
            color: black;
            padding: 10px;
            display: block;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease, font-weight 0.3s ease;
        }

        .sidebar a:hover {
            background-color: #BDC3C7;
            
        }

        .sidebar a.active {
            font-weight: bold; /* Make text bold when active */
        }

        .profile-pic-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: #BDC3C7;
            margin-right: 30px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            font-size: 20px;
        }

        .profile-info p {
            margin: 10px 0;
            line-height: 1.5;
        }

        .upload-btn {
            display: none;
        }

        h3 {
            font-size: 30px;
        }

        .profile-info p {
            font-size: 30px;
            margin-bottom: 50px;
        }

        p {
            font-size: 22px;
            margin: 27px 0;
            font-weight: normal;
            display: none;
        }

        .personal-info-heading {
            font-size: 33px;
            font-weight: bold;
            margin-bottom: 20px;
            color: black;
        }

        .password-container {
            display: inline-block;
            font-size: 22px;
        }

        .password-field {
            font-size: 22px;
            width: 180px;
            border: none;
            background: none;
            display: inline-block;
            color: #2c3e50;
        }

        .password-container:hover .password-field {
            color: black;
        }


        .users-container {
            background-color: #fff;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* Hidden by default */
        }

        .users-container h3 {
            margin-top: 0;
            color: black;
        }

        /* Table Styles */
        .users-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-container th, .users-container td {
            border: 1px solid #818585;
            padding: 10px;
            text-align: left;
            background-color: white
        }

        .users-container th {
            background-color: #350242;
            color: white;
        }

        h3{
            font-weight: 1000;
        }

        .add-user-btn {
            background-color: #350242;
            font-family: 'Times New Roman', Times, serif;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .add-user-btn:hover {
            background-color: #540d66;
        }

        .remove-btn {
            background-color: #E74C3C;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            
        }

        .remove-btn:hover {
            background-color: #C0392B;
        }

        .settings-container {
            background-color: #fafafa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .settings-container h3{
            margin-top: 0;
            margin-bottom: 5px;
            color: black;
        }

        .account-info-container {
            
            margin-bottom: 9px;
            background-color: #FFFFFF;
            border-radius: 10px;
            padding: 30px;
        }

        

        .account-info-item {
            margin-bottom: 15px;
            font-size: 25px;
        }

        .account-info-item + .account-info-item {
            margin-top: 30px; /* Adds more space between Full Name and Password */
        }

        .account-info-item label {
            font-weight: bold;
            row-gap: 100px;
            
        }

        .edit-info-btn {
            background-color: black;
            color: white;
            margin-top: 25px;
            padding: 15px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 19px;
            font-family: 'Times New Roman', Times, serif;
            transition: background-color 0.3s ease;
        }

        .edit-info-btn:hover {
            background-color: rgb(46, 45, 45);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Overlay Content */
        .overlay-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Close Button */
        .close-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        /* Form Styles */
        .overlay-content h3 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            color: black;
        }

        .form-items {
            margin-bottom: 15px;
        }

        .form-items label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: black;
        }

        .form-items input {
            width: 95%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .form-items input[type="password"] {
            font-family: Arial, sans-serif;
        }

        /* Save Button */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .save-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: black;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .save-btn:hover {
            background-color: #393a39;
        }

        /* Display the overlay */
        .overlay.active {
            display: flex;
        }

        

        .overlay-content1 {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: fixed; /* Use fixed positioning */
            top: 50%; /* Position from the top 50% */
            left: 50%; /* Position from the left 50% */
            transform: translate(-50%, -50%); /* Adjust for exact center */
            z-index: 9999; /* Ensure it's on top of other elements */
        }


        /* Close Icon */
        .close-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        /* Form Styles */
        .overlay-content1 h3 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            color: black;
        }

        .form-item {
            margin-bottom: 15px;
            position: relative;
        }

        .form-item label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: black;
        }

        .form-item select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .form-item input {
            width: 56.5%;
            padding: 10px;
            font-size: 14px;
            margin-left: 150px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .form-item button {
            position: absolute;
            left: 0;
            top: 67%;
            transform: translateY(-50%);
            padding: 10px 20px;
            font-size: 14px;
            background-color: black;
            color: #fff;
            border: none;
            border-radius: 4px 4px 4px 4px; /* Adjust border radius for the button */
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .form-item button:hover {
            background-color: #555;
        }
        /* Save Button */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .save-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: black;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .save-btn:hover {
            background-color: #393a39;
        }

        .projects-container {
    background-color: #fafafa;
    padding: 20px;
    border-radius: 5px;
    margin-top: 20px;
}

.projects-container h3 {
    margin-top: 0;
    margin-bottom: 5px;
    color: black;
}



.remove-btn {
    background-color: #E74C3C;
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.remove-btn:hover {
    background-color: #C0392B;
}

        .projects-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .projects-container th, .projects-container td {
            border: 0.5px solid #434242;
            padding: 10px;
            text-align: left;
            background-color: white;
        }

        .projects-container th {
            background-color: #350242;
            color: white;
        }

        .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center; /* Ensures perfect centering */
}

.modal-content {
    background-color: white;
    padding: 25px;
    border-radius: 12px;
    width: 320px;
    text-align: center;
    box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
}

.modal p {
    font-size: 18px;
    margin-bottom: 20px; /* Increases space between text and buttons */
    color: black;
}



.modal button {
    padding: 8px 16px; /* Makes the button smaller */
    border: none;
    border-radius: 6px; /* Slightly rounded corners */
    cursor: pointer;
    font-size: 14px; /* Reduces font size */
    transition: 0.3s;
    margin-top: 17px;
    margin-right: 15px; /* Adds space between buttons */
    min-width: 70px; /* Ensures buttons are evenly sized */
}

.modal button:last-child {
    margin-right: 0; /* Removes margin from the last button */
}


#confirmRemove {
    background-color: red;
    color: white;
}

#cancelRemove {
    background-color: gray;
    color: white;
}
.modal button:hover {
    opacity: 0.8;
}


/* Custom Alert Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content-alert {
  background-color: white;
  margin: 50px auto;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  animation: slideDown 0.4s ease-out;
  position: relative;
  top: -30px; /* Start slightly above */
}

#alert-message {
  font-size: 18px;
  color: black;
  margin-bottom: 20px;
}

#alert-ok-button {
  padding: 10px 20px;
  background-color: black;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

#alert-ok-button:hover {
  background-color: rgb(37, 37, 37);
}

/* Slide down animation */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-30px); /* Start above */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Final position */
  }
}




    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="back" onclick="window.location.href = 'AdminDashboard.html';">
        <i class="fas fa-arrow-left"></i> Back
    </div>

    <div class="content">
        <div class="profile-container" id="profile">
            <div class="profile-pic-container">
                <div class="profile-pic" id="profile-pic" onclick="triggerFileInput()"></div>
                <div class="profile-info">
                    <p><span id="fullname"></p>
                    <p1><span id="user_name"></p1>
                </div>
            </div>
            <input type="file" id="profile-upload" class="upload-btn" accept="image/*" onchange="updateProfilePic(event)">
        </div>

        
        <h3 class="personal-info-heading" id="personal-info-heading" style="display: none;">Personal Information</h3>
        <p><strong>Full Name:</strong> <span id="full-name"></span></p>
        <p><strong>Username:</strong> <span id="username"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Phone Number:</strong> <span id="phone-number"></span></p>

        

        <div class="projects-container" id="projects">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>My Projects</h3>
                
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Project Name</th>
                        
                        <th>Actions</th>
                        
                    </tr>
                    
                </thead>
                <tbody>
                    <tr>
                        <tbody id="projects-tbody">
                            <!-- Dynamic rows will be inserted here -->
                        </tbody>
                        
                        
                    </tr>
                   
                </tbody>
            </table>
        </div>
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <p1>Are you sure you want to remove this project?</p1>
                <button id="confirmRemove">Yes</button>
                <button id="cancelRemove">No</button>
            </div>
        </div>
        
        <div class="users-container" id="users">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Users List</h3>
                <!-- Add User Button -->
                <button class="add-user-btn" onclick="openOverlay()">Add User</button>
                <div id="add-user-overlay" class="overlay">
                    <div class="overlay-content1">
                        <span class="close-icon" onclick="closeOverlay()">&times;</span>
                        <h3>Add User to Project</h3>
                        <form id="add-user-form">
                            <div class="form-item">
                                <label for="select-project">Select Project:</label>
                                <select id="select-project" required>
                                    <option value="" disabled selected>Select a Project</option>
                                    
                                </select>
                            </div>
                            
                            <div class="form-item">
                                <label for="invite-code">Invite Code:</label>
                                <button id="generate-btn" onclick="generateInviteCode()">Generate Code</button>
                                <p id="countdown-text" style="color: red; font-weight: bold;"></p>

                                <input type="text" id="invite-code" placeholder="Invite Code" readonly>
                            </div>

                            <div class="form-actions" style="text-align: right;">
                                <button type="button" class="save-btn" onclick="done()">Done</button>
                            </div>
                        </form>

                    </div>
                </div>

            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Rows will be added dynamically here -->
                </tbody>
            </table>
        </div>
        <div class="settings-container" id="settings">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Account Information</h3>
            </div>
            
            <!-- Account Info Container -->
            <div class="account-info-container" style="margin-top: 20px;">
                <div class="account-info-item">
                    <label for="name">Full Name:</label>
                    <span id="name"></span>
                </div>
                <div class="account-info-item">
                    <label for="username">Username:</label>
                    <span id="user-name"></span>
                </div>
                <div class="account-info-item">
                    <label for="email">Email:</label>
                    <span id="Email"></span>
                </div>
                <div class="account-info-item">
                    <label for="password">Password:</label>
                    <span id="password"></span>
                </div>
                
                <!-- Edit Button -->
                <div class="account-info-item">
                    <button class="edit-info-btn" onclick="editInfo()">Change Password</button>
                </div>
                <div id="edit-overlay" class="overlay">
                    <div class="overlay-content">
                        <span class="close-icon" onclick="closeEditOverlay()">&times;</span>
                        <h3>Change Password</h3>
                        <form id="edit-form">
                            <div class="form-items">
                                <label for="edit-old-password">Old Password:</label>
                                <input type="password" id="edit-old-password">
                            </div>
                            <div class="form-items">
                                <label for="edit-new-password">New Password:</label>
                                <input type="newpassword" id="edit-new-password">
                            </div>
                            <div class="form-items">
                                <label for="edit-newpassword">Confirm New Password:</label>
                                <input type="confirmnewpassword" id="edit-newpassword">
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="save-btn">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Custom Alert Modal -->
                <div id="custom-alert" class="modal">
                    <div class="modal-content-alert">
                        <p1 id="alert-message"></p1>
                        <button id="alert-ok-button">OK</button>
                    </div>
                </div>

                
                
            </div>
        </div> 

        <div id="remove-user-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3>Remove this user from the project(s):</h3>
                <form id="remove-user-form">
                <div id="project-checkboxes"></div>
                <div style="margin-top: 10px;">
                    <button type="submit">Remove</button>
                    <button type="button" onclick="closeModal()">Cancel</button>
                </div>
                </form>
            </div>
        </div>
    </div>
    




    
    



    <script>
        window.onload = function () {
  fetch('sidebar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('sidebar-container').innerHTML = data;

      const links = document.querySelectorAll('.sidebar a');
      links.forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();

          links.forEach(l => l.classList.remove('active'));
          this.classList.add('active');

          showContent(this.textContent);
        });
      });

      const profileLink = document.querySelector('.sidebar a[href="#profile"]');
      if (profileLink) {
        profileLink.classList.add('active');
      }

      showContent('Profile');

      // Attach logout modal handlers AFTER sidebar is loaded
      attachLogoutHandlers();
    });
};

function showContent(contentType) {
  if (contentType !== 'Logout') {
    document.querySelectorAll('.profile-container, .projects-container, .users-container, .settings-container').forEach(container => {
      container.style.display = 'none';
    });

    const personalInfoElements = document.querySelectorAll('.content p');
    const personalInfoHeading = document.getElementById('personal-info-heading');

    personalInfoElements.forEach(element => {
      element.style.display = 'none';
    });

    if (contentType === 'Profile') {
      document.getElementById('profile').style.display = 'block';
      personalInfoHeading.style.display = 'block';
      personalInfoElements.forEach(element => {
        element.style.display = 'block';
      });
    } else if (contentType === 'Projects') {
      document.getElementById('projects').style.display = 'block';
      personalInfoHeading.style.display = 'none';
    } else if (contentType === 'Users') {
      document.getElementById('users').style.display = 'block';
      personalInfoHeading.style.display = 'none';
    } else if (contentType === 'Settings') {
      document.getElementById('settings').style.display = 'block';
      personalInfoHeading.style.display = 'none';
    }
  }

  if (contentType === 'Logout') {
    document.getElementById('logout-modal').style.display = 'flex';
  }
}

function closeLogoutModal() {
  document.getElementById('logout-modal').style.display = 'none';
}

// Attach logout logic after sidebar is injected
function attachLogoutHandlers() {
  const logoutLink = document.getElementById('logout-link');
  const confirmLogoutBtn = document.getElementById('confirm-logout');
  const cancelLogoutBtn = document.getElementById('cancel-logout');

  if (logoutLink) {
    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('logout-modal').style.display = 'flex';
    });
  }

  confirmLogoutBtn.addEventListener('click', (e) => {
  e.preventDefault();

  // Hide buttons
  confirmLogoutBtn.style.display = 'none';
  cancelLogoutBtn.style.display = 'none';

  // Hide "Are you sure..." question
  const question = document.getElementById('logout-question');
  if (question) question.style.display = 'none';

  // Show loader
  const loader = document.getElementById('logout-loader');
  if (loader) loader.style.display = 'block';

  // Wait, then redirect
  setTimeout(() => {
    sessionStorage.removeItem('jwt'); // Or sessionStorage.clear();
    window.location.replace('/Frontend/Admin/login.html');
  }, 1200);
});


  if (cancelLogoutBtn) {
    cancelLogoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      closeLogoutModal();
    });
  }
}



        function triggerFileInput() {
    document.getElementById('profile-upload').click();
}

async function updateProfilePic(event) {
    const profilePic = document.getElementById('profile-pic');
    const file = event.target.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            profilePic.style.backgroundImage = `url(${e.target.result})`;
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append('profile', file);
        const token = sessionStorage.getItem('token');
        


        try {
            const res = await fetch('http://localhost:3000/upload-profile-pic', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${token}`
                },
                body: formData
            });

            const data = await res.json();
            if (!data.success) {
                alert('Failed to upload profile picture.');
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Something went wrong while uploading.');
        }
    }
}

// Fetch and display profile picture on page load
window.addEventListener('DOMContentLoaded', async () => {
    const profilePic = document.getElementById('profile-pic');
    const token = sessionStorage.getItem('token');

    if (!token) return;

    try {
        const res = await fetch('http://localhost:3000/get-profile-pic', {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        const data = await res.json();

        if (data.profilePic) {
            profilePic.style.backgroundImage = `url(http://localhost:3000${data.profilePic})`;
        }
    } catch (err) {
        console.error('Failed to fetch profile pic:', err);
    }
});


        function showPassword() {
            document.getElementById('password').textContent = 'password123';
        }

        function hidePassword() {
            document.getElementById('password').textContent = '*********';
        }

        // Function to open the overlay
        function editInfo() {
            document.getElementById('edit-overlay').style.display = 'flex'; // Show overlay
        }

        // Function to close the overlay
        function closeEditOverlay() {
            document.getElementById('edit-overlay').style.display = 'none'; // Hide overlay
        }

        // Function to handle form submission (simulated here)
  
  function showCustomAlert(message, callback) {
      const alertMsg = document.getElementById('alert-message');
      if (alertMsg) {
        alertMsg.textContent = message;
      } else {
        console.error('Element #alert-message not found');
      }

      const modal = document.getElementById('custom-alert');
      modal.style.display = 'block';

      document.getElementById('alert-ok-button').onclick = function () {
        modal.style.display = 'none';
        if (callback) callback();
      };
    }

  document.getElementById('edit-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const oldPassword = document.getElementById('edit-old-password').value;
    const newPassword = document.getElementById('edit-new-password').value;
    const confirmPassword = document.getElementById('edit-newpassword').value;

    if (!oldPassword || !newPassword || !confirmPassword) {
      return showCustomAlert('All fields are required.');
    }

    if (newPassword !== confirmPassword) {
      return showCustomAlert('New password and confirm password do not match.');
    }

    const token = sessionStorage.getItem("token");

    fetch('http://localhost:3000/api/update-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ oldPassword, newPassword })
    })
    .then(res => res.json())
    .then(result => {
      if (result.error) {
        showCustomAlert(result.error);
      } else {
        showCustomAlert('Password updated successfully. Please log in again to continue.', () => {
          sessionStorage.removeItem("token");
          window.location.href = '/Frontend/Admin/login.html';
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showCustomAlert('An error occurred while updating the password.');
    });
  });






        function closeEditOverlay() {
            document.getElementById('edit-overlay').style.display = 'none';
        }

        

        // Function to close the overlay
function closeOverlay() {
    const overlay = document.getElementById('add-user-overlay');
    overlay.style.display = 'none';
}

// Function to open the overlay (if needed)
function openOverlay() {
    const overlay = document.getElementById('add-user-overlay');
    overlay.style.display = 'block';
}

let countdownInterval; // To track the countdown timer
let remainingTime = 10; // Initial countdown value

async function generateInviteCode() {
    const select = document.getElementById('select-project');
    const inviteCodeInput = document.getElementById('invite-code');
    const countdownText = document.getElementById('countdown-text');
    const generateButton = document.getElementById('generate-btn');

    if (!select) {
        console.error("Error: Project select dropdown not found!");
        return;
    }

    const projectId = select.value;

    if (!projectId) {
        alert("Please select a project first!");
        return;
    }

    // Disable button and show loading text
    generateButton.disabled = true;
    generateButton.textContent = "Generated";

    try {
        const response = await fetch('http://localhost:3000/generate-invite-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projectId })
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Set invite code in the input field
        inviteCodeInput.value = data.inviteCode;
        countdownText.textContent = "Invite code generated!";

        // Start countdown timer
        startCountdown(generateButton, countdownText);
        
    } catch (error) {
        console.error('Error generating invite code:', error);
        inviteCodeInput.value = "";
        countdownText.textContent = "Invalid code. Try again!";
        countdownText.style.color = "red"; // Change text color to red for error

        // Enable button after 3 seconds if there was an error
        setTimeout(() => {
            generateButton.disabled = false;
            generateButton.textContent = "Generate Code";
            countdownText.textContent = "";
        }, 3000);
    }
}

// Countdown function
function startCountdown(button, countdownText) {
    remainingTime = 10; // Reset countdown
    countdownText.style.color = "black"; // Reset text color
    countdownInterval = setInterval(() => {
        remainingTime--;
        countdownText.textContent = `Get new code in ${remainingTime}...`;

        if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            button.disabled = false;
            button.textContent = "Generate Code";
            countdownText.textContent = "";
        }
    }, 1000);
}

// Function for "Done" button action
function done() {
    const project = document.getElementById('select-project').value;
    const inviteCode = document.getElementById('invite-code').value;

    if (project && inviteCode) {
        alert(`User added to ${project} with invite code: ${inviteCode}`);
        closeOverlay(); // Close the overlay after "Done"
    } else {
        alert('Please select a project and generate the invite code.');
    }
}

// Close overlay when clicking outside
window.onclick = function(event) {
    const overlay = document.getElementById('add-user-overlay');
    if (event.target === overlay) {
        closeOverlay();
    }
};


document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Get the token from sessionStorage (changed from localStorage)
        const token = sessionStorage.getItem('token'); // Replace with sessionStorage

        if (!token) {
            throw new Error('No token found, please log in');
        }

        // Fetch the project data from the backend with the token in the Authorization header
        const response = await fetch('http://localhost:3000/project', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}` // Include the token in the Authorization header
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch projects');
        }
        
        const projects = await response.json();
        
        // Get the select element
        const selectElement = document.getElementById('select-project');
        
        // Clear any existing options
        selectElement.innerHTML = '<option value="" disabled selected>Select a Project</option>';
        
        // Loop through the projects and append them as options to the select element
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;  // Assuming the response has an "id" field
            option.textContent = project.name; // Assuming the response has a "name" field
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching projects:', error);
    }
});


// Function to fetch and reindex projects
async function fetchProjects() {
    try {
        // Get the token from sessionStorage (changed from localStorage)
        const token = sessionStorage.getItem('token'); // Use sessionStorage

        if (!token) {
            throw new Error('No token found, please log in');
        }

        // Fetch projects from the backend API with the token in the Authorization header
        const response = await fetch('http://localhost:3000/project', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}` // Include the token in the Authorization header
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch projects');
        }

        const projects = await response.json();

        // Populate the table with project data
        const tbody = document.getElementById('projects-tbody');
        tbody.innerHTML = ''; // Clear existing rows, if any

        if (projects.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3">No projects available</td></tr>`;
        }

        // Reindex the ID values and update the table
        projects.forEach((project, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td> <!-- Reindex IDs starting from 1 -->
                <td>${project.name}</td>
                <td><button class="remove-btn" onclick="showConfirmDialog('${project.project_key}')">Remove</button></td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error:', error);
        alert('Could not fetch projects. Please try again later.');
    }
}

    // Call the fetchProjects function when the page loads
    document.addEventListener('DOMContentLoaded', fetchProjects);

    let projectToRemove = null;

// Function to show confirmation dialog
function showConfirmDialog(projectKey) {
    projectToRemove = projectKey; // Store project key for removal
    document.getElementById("confirmModal").style.display = "flex";
}

// Function to hide the modal
function closeConfirmDialog() {
    document.getElementById("confirmModal").style.display = "none";
    projectToRemove = null;
}


document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmModal");

    // Ensure the modal is hidden when the page loads
    modal.style.display = "none";

    document.getElementById("cancelRemove").addEventListener("click", function () {
        modal.style.display = "none";
    });
});


// Attach event listeners to modal buttons
document.getElementById("confirmRemove").addEventListener("click", async function() {
    if (projectToRemove !== null) {
        await removeProject(projectToRemove);
    }
    closeConfirmDialog();
});

document.getElementById("cancelRemove").addEventListener("click", closeConfirmDialog);

// Function to delete project
async function removeProject(projectKey) {
    try {
        // Get the token from sessionStorage (changed from localStorage)
        const token = sessionStorage.getItem('token'); // Use sessionStorage

        if (!token) {
            throw new Error('No token found, please log in');
        }

        const response = await fetch(`http://localhost:3000/project/${projectKey}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}` // Include token in the Authorization header
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete project');
        }

        alert('Project removed successfully!');
        fetchProjects(); // Refresh the project list and reindex
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to remove project. Please try again later.');
    }
}

let adminProjectKey = null; // This will store the project key

// Function to fetch projectKey from the backend
async function fetchProjectKey() {
    const token = sessionStorage.getItem('token');

    const response = await fetch('http://localhost:3000/get-project-keys', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });

    const data = await response.json();

    if (data.projectKeys && data.projectKeys.length > 0) {
        console.log("All Project Keys:", data.projectKeys);
        // Loop over projects or let admin pick one
        data.projectKeys.forEach(projectKey => {
            fetchUsersForProject(projectKey);
        });
    } else {
        console.log("No project keys received.");
    }
}


// Call this function when the page loads or when you need the project key
document.addEventListener("DOMContentLoaded", fetchProjectKey);


// Function to fetch users from the backend
async function fetchUsersForProject(projectKey) {
    const token = sessionStorage.getItem('token');
    if (!token || !projectKey) return;

    try {
        const res = await fetch(`http://localhost:3000/get-users?projectKey=${projectKey}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const users = await res.json();

        if (!Array.isArray(users)) {
            console.error("Invalid users response");
            return;
        }

        users.forEach(user => addUserToTable(user));

    } catch (err) {
        console.error('‚ùå Error fetching users:', err);
    }
}


// WebSocket connection (initialized only after fetching project key)
function setupWebSocket() {
    const socket = new WebSocket('ws://localhost:3000'); // Change for production

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'USER_JOINED' && data.projectKey === adminProjectKey) {
            addUserToTable(data.user);
        }
    };
}

// Function to add a new user row in the admin table
let userCounter = 1.; // Start the counter at 1
const displayedEmails = new Set();

function addUserToTable(user) {
    if (displayedEmails.has(user.email)) return; 
    const tableBody = document.getElementById("users-table-body");

    // Create a new table row
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${userCounter++}.</td>  <!-- Incremental ID -->
        <td>${user.fullname}</td>
        <td>${user.email}</td>
        <td><button class="remove-btn" onclick="removeUser(${user.id})">Remove</button></td>
    `;

    tableBody.appendChild(row);
    displayedEmails.add(user.email); // Mark this email as displayed
}


// Fetch project key first, then proceed
document.addEventListener("DOMContentLoaded", fetchProjectKey);


document.addEventListener("DOMContentLoaded", () => {
    const token = sessionStorage.getItem("token"); // or get user id/email if that's stored instead

    if (token) {
      fetch('http://localhost:3000/api/user/profile', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('fullname').textContent = data.fullname;
        document.getElementById('user_name').textContent = data.username;

        document.getElementById('full-name').textContent = data.fullname;
        document.getElementById('username').textContent = data.username;
        document.getElementById('email').textContent = data.email;
        document.getElementById('phone-number').textContent = data.phone_number;

        document.getElementById('name').textContent = data.fullname;
        document.getElementById('user-name').textContent = data.username;
        document.getElementById('Email').textContent = data.email;
        document.getElementById('password').textContent = "*******";


      })
      .catch(error => {
        console.error('Error fetching user data:', error);
      });
    }
  });

    let currentUserId = null;

function removeUser(userId) {
  currentUserId = userId;
    
  const token = sessionStorage.getItem("token");

  fetch(`http://localhost:3000/user-projects/${userId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
    .then(res => res.json())
    .then(projects => {
      const checkboxesContainer = document.getElementById('project-checkboxes');
      checkboxesContainer.innerHTML = '';

      if (projects.length === 0) {
        checkboxesContainer.innerHTML = '<p>No projects found for this user.</p>';
        return;
      }

      projects.forEach(p => {
        const checkbox = document.createElement('div');
        checkbox.innerHTML = `
          <label>
            <input type="checkbox" value="${p.project_key}">
            ${p.project_name}
          </label>
        `;
        checkboxesContainer.appendChild(checkbox);
      });

      document.getElementById('remove-user-modal').style.display = 'block';
    })
    .catch(err => console.error('Error fetching projects:', err));
}

document.getElementById('remove-user-form').addEventListener('submit', function (e) {
  e.preventDefault();

  const token = sessionStorage.getItem("token");

  const selectedProjects = Array.from(
    document.querySelectorAll('#project-checkboxes input[type="checkbox"]:checked')
  ).map(cb => cb.value);

  if (selectedProjects.length === 0) {
    alert('Please select at least one project to remove.');
    return;
  }

  fetch('http://localhost:3000/remove-user-from-projects', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      userId: currentUserId,
      projectKeys: selectedProjects
    })
  })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.removeUserRow) {
        // Remove the entire row from table if user is not part of any project
        const rowToRemove = document.querySelector(`button[onclick="removeUser(${currentUserId})"]`).closest('tr');
        if (rowToRemove) rowToRemove.remove();
      }
      closeModal();
    })
    .catch(err => console.error('Remove error:', err));
});

function closeModal() {
  document.getElementById('remove-user-modal').style.display = 'none';
  currentUserId = null;
}



    </script>
</body>
</html>